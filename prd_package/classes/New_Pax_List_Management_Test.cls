@isTest
private class New_Pax_List_Management_Test {
	
	@testSetup static void DataPreparation(){
		List<Flight__c> flightList = new List<Flight__c>();
		Flight__c flight1 = new Flight__c(
			Name = '0628',
		    Flight_Number__c = 'TG0628',
		    Flight_Date_UTC__c = '20Dec25',
		    Flight_Date_LT__c = '20Dec25',
		    Departure_STN__c  = 'BKK',
		    STD_UTC__c = '20Dec25 0330',
		    STD_LT__c  = '20Dec25 1030',
		    STA_UTC__c = '20Dec25 0620',
		    STA_LT__c = '20Dec25 1420',
		    Block_Time__c = '170',
		    Integration_Source__c = '1',
		    Leg_Number__c = 1,
		    Flight_External_ID__c = 'TG0628_20Dec25_1');
		flightList.add(flight1);

		List<Passenger__c> paxList = new List<Passenger__c>();
		Passenger__c pax1 = new Passenger__c(
			First_Name__c = 'Nat Earth Mr',
			Last_Name__c = 'Pho-ngoen',
			PNR__c = '22QS3U',
			WS_Key__c = '0628_2025-12-20_Nat Earth Mr_Pho-ngoen_22QS3U_1'
		);
		paxList.add(pax1);

		insert flightList;
		insert paxList;
	}

	@isTest static void testGetPaxMapWithKey(){
		List<Passenger__c> paxList = [SELECT Id, WS_Key__c FROM Passenger__c];
		Map<String, Passenger__c> paxMap = New_Pax_List_Management.getPaxMapWithKey(paxList);
		System.debug('JK: Debug');
		System.debug(paxMap);
	}

	@isTest static void testGetKeyFromWSKey(){
		String wscomparekey = '628_2025-12-20_NatEarthMr_Pho-ngoen_22QS3U_1';
		wscomparekey = wscomparekey.toLowerCase();
		List<Passenger__c> paxList = [SELECT Id, WS_Key__c FROM Passenger__c WHERE WS_Key__c = '0628_2025-12-20_Nat Earth Mr_Pho-ngoen_22QS3U_1'];
		String wskeyfrompax = New_Pax_List_Management.getKeyFromWSKey(paxList.get(0).WS_Key__c);
		System.assertEquals(wscomparekey, wskeyfrompax, 'space in WS Key from pax should be removed - get key from pax method');
	}

	@isTest static void testGetKey(){
		String wscomparekey = '628_2025-12-20_NatEarthMr_Pho-ngoen_22QS3U_1';
		wscomparekey = wscomparekey.toLowerCase();

		String wskeyfrompax = New_Pax_List_Management.getKey('628', '2025-12-20', 'Nat Earth MR', 'Pho-ngoen', '22QS3U', '1');
		System.assertEquals(wscomparekey, wskeyfrompax, 'space in WS Key from pax should be removed - get key method');
	}

	@isTest static void testGetFlightSTD(){
		String response = '<flightDetailsGroup xmlns="http://xml.thaiairways.com/dcs/listing/pax/getpaxlist/v1_0">    <legDetails>        <carrierDetails>            <marketingCarrier>TG</marketingCarrier>        </carrierDetails>        <flightDetails>            <flightNumber>628</flightNumber>        </flightDetails>        <departureDate>2025-12-20</departureDate>        <boardPoint>BKK</boardPoint>    </legDetails>    <aircraftInfo>        <Equip>            <meanTypeCode>74A</meanTypeCode>            <characteristics>330</characteristics>        </Equip>    </aircraftInfo>    <flightStatus>        <statusInfo>            <indicator>GN</indicator>            <action>OP</action>        </statusInfo>    </flightStatus>    <flightStatus>        <statusInfo>            <indicator>AC</indicator>            <action>OP</action>        </statusInfo>    </flightStatus>    <flightStatus>        <statusInfo>            <indicator>BO</indicator>            <action>NO</action>        </statusInfo>    </flightStatus>    <flightStatus>        <statusInfo>            <indicator>LC</indicator>            <action>OP</action>        </statusInfo>    </flightStatus>    <flightStatus>        <statusInfo>            <indicator>BG</indicator>            <action>IG</action>        </statusInfo>    </flightStatus>    <flightStatus>        <statusInfo>            <indicator>SDE</indicator>            <action>0</action>        </statusInfo>    </flightStatus>    <flightStatus>        <statusInfo>            <indicator>BDE</indicator>            <action>0</action>        </statusInfo>    </flightStatus>    <flightStatus>        <statusInfo>            <indicator>BSR</indicator>            <action>0</action>        </statusInfo>    </flightStatus>    <flightStatus>        <statusInfo>            <indicator>DIS</indicator>            <action>NDI</action>        </statusInfo>    </flightStatus>    <timeData>        <businessSemantic>STD</businessSemantic>        <timeMode>LT</timeMode>        <dateTime>2025-12-20T10:30:00</dateTime>    </timeData>    <timeData>        <businessSemantic>BOT</businessSemantic>        <timeMode>LT</timeMode>        <dateTime>2025-12-20T09:50:00</dateTime>    </timeData>    <timeData>        <businessSemantic>STA</businessSemantic>        <timeMode>LT</timeMode>        <dateTime>2025-12-20T14:20:00</dateTime>    </timeData>    <terminalInfo>        <airportCode>BKK</airportCode>    </terminalInfo>    <flightMode>        <attributeFunction>BPW</attributeFunction>        <attributeDetails>            <attributeType>PW</attributeType>        </attributeDetails>    </flightMode>    <totalByCabin>        <cabin>            <cabinDetails>                <classDesignator>C</classDesignator>            </cabinDetails>        </cabin>        <total>            <quantityDetails>                <numberOfUnit>1</numberOfUnit>                <unitQualifier>CUS</unitQualifier>            </quantityDetails>        </total>        <cabinIndicators>            <statusInfo>                <indicator>FSI</indicator>                <action>0</action>            </statusInfo>        </cabinIndicators>        <cabinIndicators>            <statusInfo>                <indicator>CGI</indicator>                <action>0</action>            </statusInfo>        </cabinIndicators>    </totalByCabin>    <totalByCabin>        <cabin>            <cabinDetails>                <classDesignator>Y</classDesignator>            </cabinDetails>        </cabin>        <total>            <quantityDetails>                <numberOfUnit>12</numberOfUnit>                <unitQualifier>CUS</unitQualifier>            </quantityDetails>        </total>        <cabinIndicators>            <statusInfo>                <indicator>FSI</indicator>                <action>0</action>            </statusInfo>        </cabinIndicators>        <cabinIndicators>            <statusInfo>                <indicator>CGI</indicator>                <action>0</action>            </statusInfo>        </cabinIndicators>    </totalByCabin>    <customerLevel>        <customerData>            <paxDetails>                <surname>Pho-ngoen</surname>                <type>A</type>                <gender>M</gender>            </paxDetails>            <otherPaxDetails>                <givenName>Nat Earth</givenName>                <title>MR</title>            </otherPaxDetails>        </customerData>        <uniqueCustomerId>            <idSection>                <referenceQualifier>UCI</referenceQualifier>                <primeId>2301C91C000054FB</primeId>            </idSection>        </uniqueCustomerId>        <customerStatus>            <statusInfo>                <indicator>CAS</indicator>                <action>CAC</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>AAC</indicator>                <action>0</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>CBS</indicator>                <action>NBD</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>EST</indicator>                <action>0</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>CBG</indicator>                <action>0</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>IFT</indicator>                <action>0</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>CHD</indicator>                <action>0</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>UMN</indicator>                <action>0</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>TST</indicator>                <action>0</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>API</indicator>                <action>1</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>ODP</indicator>                <action>0</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>IFA</indicator>                <action>1</action>            </statusInfo>        </customerStatus>        <paxDateTime>            <businessSemantic>706</businessSemantic>            <timeMode>LD</timeMode>            <dateTime>1980-06-20T00:00:00</dateTime>        </paxDateTime>        <productLevel>            <bookingData>                <statusCode>HK</statusCode>            </bookingData>            <productID>                <idSection>                    <referenceQualifier>DID</referenceQualifier>                    <primeId>2301D91C00033F99</primeId>                </idSection>            </productID>            <sbrRecordLocator>                <reservation>                    <controlNumber>22QS3U</controlNumber>                </reservation>            </sbrRecordLocator>            <flightInfo>                <flightDate>                    <departureDate>2025-12-20</departureDate>                </flightDate>                <boardPointDetails>                    <trueLocnId>BKK</trueLocnId>                </boardPointDetails>                <offpointDetails>                    <trueLocnId>HKG</trueLocnId>                </offpointDetails>                <companyDetails>                    <marketingCompany>TG</marketingCompany>                </companyDetails>                <flightIdentification>                    <flightNumber>628</flightNumber>                    <bookingClass>Y</bookingClass>                </flightIdentification>            </flightInfo>        </productLevel>        <otherFlightInfo>            <otherFlightData>                <flightDate>                    <departureDate>2025-12-20</departureDate>                </flightDate>                <boardPointDetails>                    <trueLocnId>BKK</trueLocnId>                </boardPointDetails>                <offpointDetails>                    <trueLocnId>HKG</trueLocnId>                </offpointDetails>                <companyDetails>                    <marketingCompany>TG</marketingCompany>                </companyDetails>                <flightIdentification>                    <flightNumber>606</flightNumber>                    <bookingClass>Y</bookingClass>                </flightIdentification>            </otherFlightData>            <flightTypeIndicator>                <statusInfo>                    <indicator>FIT</indicator>                    <action>OFL</action>                </statusInfo>            </flightTypeIndicator>            <acceptanceStatus>                <statusInfo>                    <indicator>CAS</indicator>                    <action>CNA</action>                </statusInfo>            </acceptanceStatus>            <operatingDetails>                <companyDetails>                    <operatingCompany>TG</operatingCompany>                </companyDetails>                <flightIdentification>                    <flightNumber>606</flightNumber>                </flightIdentification>            </operatingDetails>            <cabinData>                <cabinDetails>                    <classDesignator>Y</classDesignator>                </cabinDetails>            </cabinData>            <timeData>                <businessSemantic>STD</businessSemantic>                <timeMode>LT</timeMode>                <dateTime>2025-12-20T16:00:00</dateTime>            </timeData>            <timeData>                <businessSemantic>STA</businessSemantic>                <timeMode>LT</timeMode>                <dateTime>2025-12-20T19:45:00</dateTime>            </timeData>            <timeData>                <businessSemantic>BOT</businessSemantic>                <timeMode>LT</timeMode>                <dateTime>2025-12-20T15:20:00</dateTime>            </timeData>        </otherFlightInfo>        <secNumber>            <referenceDetails>                <type>4</type>                <value>BKK-001</value>            </referenceDetails>        </secNumber>        <legCabinCode>            <cabinDetails>                <classDesignator>Y</classDesignator>            </cabinDetails>        </legCabinCode>        <dummy/>        <bookedCabinCode>            <cabinDetails>                <classDesignator>Y</classDesignator>            </cabinDetails>        </bookedCabinCode>        <seatInfo>            <seatStatusInfo>                <statusInfo>                    <indicator>SS</indicator>                    <action>GUA</action>                </statusInfo>            </seatStatusInfo>            <seatNumberInfo>                <seatDetails>                    <seatNumber>035F</seatNumber>                </seatDetails>            </seatNumberInfo>        </seatInfo>        <dummySTX/>        <dummySegment/>        <dummy3/> </customerLevel></flightDetailsGroup>';
		WS_New_Pax_List_Model newPaxModel = (WS_New_Pax_List_Model)new XMLSerializer().deSerialize(response, WS_New_Pax_List_Model.class, new Set<String>{'customerLevel', 'timeData', 'otherFlightInfo'});
		List<WS_New_Pax_List_Model.cls_timeData> timedata = newPaxModel.flightDetailsGroup.timeData;
		String stdfrommethod = New_Pax_List_Management.getFlightSTD(timedata);
		String flightstdtocompare = '2025-12-20T10:30:00.000Z';
		System.assertEquals(flightstdtocompare, stdfrommethod, 'Compare flight std datetime');
	}

	@isTest static void testGetDateTimeFormat(){
		String comparedatetime = '2025-12-20T10:30:00.000Z';
		String datetimefrommethod = New_Pax_List_Management.getDateTimeFormat('2025-12-20T10:30:00');
		System.assertEquals(comparedatetime, datetimefrommethod, 'Compare datetime format');
	}

	@isTest static void testUpdatePaxConnectingFltInfo(){
		List<Flight__c> flightList = [SELECt Id, Name, Flight_Number__c, Flight_Date_UTC__c, Departure_STN__c, Leg_Number__c FROM Flight__c WHERE Flight_External_ID__c = 'TG0628_20Dec25_1'];
		List<Passenger__c> paxList = [SELECT Id, WS_Key__c FROM Passenger__c];
		String response = '<flightDetailsGroup xmlns="http://xml.thaiairways.com/dcs/listing/pax/getpaxlist/v1_0">    <legDetails>        <carrierDetails>            <marketingCarrier>TG</marketingCarrier>        </carrierDetails>        <flightDetails>            <flightNumber>628</flightNumber>        </flightDetails>        <departureDate>2025-12-20</departureDate>        <boardPoint>BKK</boardPoint>    </legDetails>    <aircraftInfo>        <Equip>            <meanTypeCode>74A</meanTypeCode>            <characteristics>330</characteristics>        </Equip>    </aircraftInfo>    <flightStatus>        <statusInfo>            <indicator>GN</indicator>            <action>OP</action>        </statusInfo>    </flightStatus>    <flightStatus>        <statusInfo>            <indicator>AC</indicator>            <action>OP</action>        </statusInfo>    </flightStatus>    <flightStatus>        <statusInfo>            <indicator>BO</indicator>            <action>NO</action>        </statusInfo>    </flightStatus>    <flightStatus>        <statusInfo>            <indicator>LC</indicator>            <action>OP</action>        </statusInfo>    </flightStatus>    <flightStatus>        <statusInfo>            <indicator>BG</indicator>            <action>IG</action>        </statusInfo>    </flightStatus>    <flightStatus>        <statusInfo>            <indicator>SDE</indicator>            <action>0</action>        </statusInfo>    </flightStatus>    <flightStatus>        <statusInfo>            <indicator>BDE</indicator>            <action>0</action>        </statusInfo>    </flightStatus>    <flightStatus>        <statusInfo>            <indicator>BSR</indicator>            <action>0</action>        </statusInfo>    </flightStatus>    <flightStatus>        <statusInfo>            <indicator>DIS</indicator>            <action>NDI</action>        </statusInfo>    </flightStatus>    <timeData>        <businessSemantic>STD</businessSemantic>        <timeMode>LT</timeMode>        <dateTime>2025-12-20T10:30:00</dateTime>    </timeData>    <timeData>        <businessSemantic>BOT</businessSemantic>        <timeMode>LT</timeMode>        <dateTime>2025-12-20T09:50:00</dateTime>    </timeData>    <timeData>        <businessSemantic>STA</businessSemantic>        <timeMode>LT</timeMode>        <dateTime>2025-12-20T14:20:00</dateTime>    </timeData>    <terminalInfo>        <airportCode>BKK</airportCode>    </terminalInfo>    <flightMode>        <attributeFunction>BPW</attributeFunction>        <attributeDetails>            <attributeType>PW</attributeType>        </attributeDetails>    </flightMode>    <totalByCabin>        <cabin>            <cabinDetails>                <classDesignator>C</classDesignator>            </cabinDetails>        </cabin>        <total>            <quantityDetails>                <numberOfUnit>1</numberOfUnit>                <unitQualifier>CUS</unitQualifier>            </quantityDetails>        </total>        <cabinIndicators>            <statusInfo>                <indicator>FSI</indicator>                <action>0</action>            </statusInfo>        </cabinIndicators>        <cabinIndicators>            <statusInfo>                <indicator>CGI</indicator>                <action>0</action>            </statusInfo>        </cabinIndicators>    </totalByCabin>    <totalByCabin>        <cabin>            <cabinDetails>                <classDesignator>Y</classDesignator>            </cabinDetails>        </cabin>        <total>            <quantityDetails>                <numberOfUnit>12</numberOfUnit>                <unitQualifier>CUS</unitQualifier>            </quantityDetails>        </total>        <cabinIndicators>            <statusInfo>                <indicator>FSI</indicator>                <action>0</action>            </statusInfo>        </cabinIndicators>        <cabinIndicators>            <statusInfo>                <indicator>CGI</indicator>                <action>0</action>            </statusInfo>        </cabinIndicators>    </totalByCabin>    <customerLevel>        <customerData>            <paxDetails>                <surname>Pho-ngoen</surname>                <type>A</type>                <gender>M</gender>            </paxDetails>            <otherPaxDetails>                <givenName>Nat Earth</givenName>                <title>MR</title>            </otherPaxDetails>        </customerData>        <uniqueCustomerId>            <idSection>                <referenceQualifier>UCI</referenceQualifier>                <primeId>2301C91C000054FB</primeId>            </idSection>        </uniqueCustomerId>        <customerStatus>            <statusInfo>                <indicator>CAS</indicator>                <action>CAC</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>AAC</indicator>                <action>0</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>CBS</indicator>                <action>NBD</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>EST</indicator>                <action>0</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>CBG</indicator>                <action>0</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>IFT</indicator>                <action>0</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>CHD</indicator>                <action>0</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>UMN</indicator>                <action>0</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>TST</indicator>                <action>0</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>API</indicator>                <action>1</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>ODP</indicator>                <action>0</action>            </statusInfo>        </customerStatus>        <customerStatus>            <statusInfo>                <indicator>IFA</indicator>                <action>1</action>            </statusInfo>        </customerStatus>        <paxDateTime>            <businessSemantic>706</businessSemantic>            <timeMode>LD</timeMode>            <dateTime>1980-06-20T00:00:00</dateTime>        </paxDateTime>        <productLevel>            <bookingData>                <statusCode>HK</statusCode>            </bookingData>            <productID>                <idSection>                    <referenceQualifier>DID</referenceQualifier>                    <primeId>2301D91C00033F99</primeId>                </idSection>            </productID>            <sbrRecordLocator>                <reservation>                    <controlNumber>22QS3U</controlNumber>                </reservation>            </sbrRecordLocator>            <flightInfo>                <flightDate>                    <departureDate>2025-12-20</departureDate>                </flightDate>                <boardPointDetails>                    <trueLocnId>BKK</trueLocnId>                </boardPointDetails>                <offpointDetails>                    <trueLocnId>HKG</trueLocnId>                </offpointDetails>                <companyDetails>                    <marketingCompany>TG</marketingCompany>                </companyDetails>                <flightIdentification>                    <flightNumber>628</flightNumber>                    <bookingClass>Y</bookingClass>                </flightIdentification>            </flightInfo>            <TktInfo>                <Tkt>                    <documentDetails>                        <number>2172315534748</number>                        <type>E</type>                    </documentDetails>                </Tkt>            </TktInfo>        </productLevel>        <otherFlightInfo>            <otherFlightData>                <flightDate>                    <departureDate>2025-12-20</departureDate>                </flightDate>                <boardPointDetails>                    <trueLocnId>BKK</trueLocnId>                </boardPointDetails>                <offpointDetails>                    <trueLocnId>HKG</trueLocnId>                </offpointDetails>                <companyDetails>                    <marketingCompany>TG</marketingCompany>                </companyDetails>                <flightIdentification>                    <flightNumber>606</flightNumber>                    <bookingClass>Y</bookingClass>                </flightIdentification>            </otherFlightData>            <flightTypeIndicator>                <statusInfo>                    <indicator>FIT</indicator>                    <action>OFL</action>                </statusInfo>            </flightTypeIndicator>            <acceptanceStatus>                <statusInfo>                    <indicator>CAS</indicator>                    <action>CNA</action>                </statusInfo>            </acceptanceStatus>            <operatingDetails>                <companyDetails>                    <operatingCompany>TG</operatingCompany>                </companyDetails>                <flightIdentification>                    <flightNumber>606</flightNumber>                </flightIdentification>            </operatingDetails>            <cabinData>                <cabinDetails>                    <classDesignator>Y</classDesignator>                </cabinDetails>            </cabinData>            <timeData>                <businessSemantic>STD</businessSemantic>                <timeMode>LT</timeMode>                <dateTime>2025-12-20T16:00:00</dateTime>            </timeData>            <timeData>                <businessSemantic>STA</businessSemantic>                <timeMode>LT</timeMode>                <dateTime>2025-12-20T19:45:00</dateTime>            </timeData>            <timeData>                <businessSemantic>BOT</businessSemantic>                <timeMode>LT</timeMode>                <dateTime>2025-12-20T15:20:00</dateTime>            </timeData>        </otherFlightInfo>        <secNumber>            <referenceDetails>                <type>4</type>                <value>BKK-001</value>            </referenceDetails>        </secNumber>        <legCabinCode>            <cabinDetails>                <classDesignator>F</classDesignator>            </cabinDetails>        </legCabinCode>        <dummy/>        <bookedCabinCode>            <cabinDetails>                <classDesignator>Y</classDesignator>            </cabinDetails>        </bookedCabinCode>        <seatInfo>            <seatStatusInfo>                <statusInfo>                    <indicator>SS</indicator>                    <action>GUA</action>                </statusInfo>            </seatStatusInfo>            <seatNumberInfo>                <seatDetails>                    <seatNumber>035F</seatNumber>                </seatDetails>            </seatNumberInfo>        </seatInfo>        <dummySTX/>        <dummySegment/>        <dummy3/> </customerLevel></flightDetailsGroup>';
		WS_New_Pax_List_Model newPaxModel = (WS_New_Pax_List_Model)new XMLSerializer().deSerialize(response, WS_New_Pax_List_Model.class, new Set<String>{'customerLevel', 'timeData', 'otherFlightInfo'});
		New_Pax_List_Management.updatePaxConnectingFltInfoAndTkt(paxList, flightList.get(0), newPaxModel);
		System.debug('JK: Debug - testUpdatePaxConnectingFltInfo');
		System.debug(paxList);
	}
}